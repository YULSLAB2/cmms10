<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/defaultLayout}">

<head>
    <title th:text="#{inventoryIoHistory}">재고 입출고 이력</title>
    <link rel="stylesheet" th:href="@{/webjars/handsontable/11.1.0/dist/handsontable.full.min.css}" />
    <script th:src="@{/webjars/handsontable/11.1.0/dist/handsontable.full.min.js}"></script>
</head>

<body>
    <div layout:fragment="content">
        <div class="max-w-6xl mx-auto p-4">

            <h2 class="text-2xl font-bold mb-4" th:text="#{inventoryIoHistory}">재고 입출고 이력</h2>

            <!-- 숨겨진 필드: 회사 ID -->
            <input type="hidden" id="companyId" th:value="${companyId}" />

            <div id="hot"></div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="saveBtn"
                    class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    th:text="#{save}">저장</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const container = document.getElementById('hot');
        const ctx = /*[[${#httpServletRequest.contextPath}]]*/ '';
        const companyId = document.getElementById('companyId').value;

        const hot = new Handsontable(container, {
            data: [],
            colHeaders: ['입출고일자', '유형', '사업장', '재고ID', '재고명', '수량', '단가', '금액', '비고'],
            columns: [
                { data: 'ioDate', type: 'date', dateFormat: 'YYYY-MM-DD' },
                {
                    data: 'ioType', type: 'dropdown',
                    source: ['IN', 'OUT']
                },
                { data: 'siteId', type: 'text' },
                { data: 'inventoryId', type: 'text' },
                { data: 'inventoryName', readOnly: true },
                { data: 'qty', type: 'numeric' },
                { data: 'unitPrice', type: 'numeric' },
                { data: 'totalValue', type: 'numeric', readOnly: true },
                { data: 'note', type: 'text' }
            ],
            stretchH: 'all',
            rowHeaders: true,
            minSpareRows: 5,
            licenseKey: 'non-commercial-and-evaluation',

            afterChange: function (changes, source) {
                if (source === 'edit' && changes) {
                    changes.forEach(([row, prop, oldValue, newValue]) => {
                        if (prop === 'inventoryId') {
                            const inventoryId = newValue;
                            if (inventoryId) {
                                fetch(`${ctx}/inventoryMaster/api/nameById?companyId=${companyId}&inventoryId=${inventoryId}`)
                                    .then(res => res.ok ? res.json() : Promise.reject(res))
                                    .then(data => {
                                        hot.setDataAtCell(row, 4, data.inventoryName || 'Not found');
                                    })
                                    .catch(() => {
                                        hot.setDataAtCell(row, 4, 'Invalid ID');
                                    });
                            }
                        }

                        if (prop === 'qty' || prop === 'unitPrice') {
                            const qty = hot.getDataAtRowProp(row, 'qty') || 0;
                            const price = hot.getDataAtRowProp(row, 'unitPrice') || 0;
                            hot.setDataAtRowProp(row, 'totalValue', qty * price);
                        }
                    });
                }
            }
        });

        document.getElementById('saveBtn').addEventListener('click', () => {
            const rows = hot.getData().filter(r => r[3]); // inventoryId 존재하는 행만 저장

            const payload = rows.map(r => ({
                ioDate: r[0],
                ioType: r[1],
                siteId: r[2],
                inventoryId: r[3],
                qty: r[5],
                unitPrice: r[6],
                totalValue: r[7],
                note: r[8]
            }));

            fetch(`${ctx}/inventoryIo/InventoryIoSave`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.text())
                .then(text => {
                    if (text.startsWith('lock:')) {
                        alert('잠금 상태로 저장할 수 없습니다.');
                    } else if (text === 'success') {
                        alert('저장되었습니다.');
                        location.reload();
                    } else {
                        alert('저장 중 오류가 발생했습니다: ' + text);
                    }
                })
                .catch(err => {
                    alert('서버 오류: ' + err);
                });
        });
    </script>
</body>

</html>
<!-- workPermitForm.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>작업허가서 등록</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="max-w-4xl mx-auto mt-8 space-y-6">
            <h2 class="text-2xl font-bold" th:text="${workpermit.permitId == null ? '작업허가서 신규' : '작업허가서 수정: ' + workpermit.permitId}">작업허가서 등록</h2>
            <!-- Alerts -->
            <div th:if="${successMessage}" class="p-3 bg-green-100 text-green-800 rounded">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="p-3 bg-red-100 text-red-800 rounded">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{/workpermit/workpermitSave}" method="post" th:object="${workpermit}" onsubmit="saveSignature()">
                <!-- Hidden fields -->
                <input type="hidden" th:field="*{companyId}" />
                <input type="hidden" th:field="*{siteId}" />
                <!-- Basic Info -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">Basic Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Permit ID</label>
                            <input type="text" th:field="*{permitId}" class="w-full border rounded px-2 py-1 bg-gray-100" readonly />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Plant ID</label>
                            <input type="text" th:field="*{plantId}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Permit Name</label>
                            <input type="text" th:field="*{permitName}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Permit Type</label>
                            <input type="text" th:field="*{permitType}" class="w-full border rounded px-2 py-1" />
                        </div>
                    </div>
                </div>
                <!-- Permit Period -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">Permit Period</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Start Date</label>
                            <input type="datetime-local" th:field="*{startDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">End Date</label>
                            <input type="datetime-local" th:field="*{endDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                    </div>
                </div>
                <!-- Permit Type -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">Permit Type</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Permit Type</label>
                            <input type="text" th:field="*{permitType}" class="w-full border rounded px-2 py-1" />
                        </div>
                    </div>
                </div>
                <!-- Permit Description -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">Permit Description</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Work Description</label>
                            <textarea th:field="*{workDesc}" rows="3" class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Hazard Note</label>
                            <textarea th:field="*{hazardNote}" rows="3" class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Safety Measures -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">Permit Safety Measures</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> 
                        <div>
                            <label class="block text-sm font-medium mb-1">Safety Measure</label>
                            <textarea th:field="*{safetyMeasure}" rows="3" class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Signatures items-->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">Permit Signatures</h3>
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Signer Name</th>
                                <th>Signature</th>
                            </tr>
                        </thead>
                        <tbody id="itemTableBody">
                            <tr th:each="item, iterStat : *{items}">
                                <td>
                                    <input type="text" th:field="*{items[__${iterStat.index}__].signerName}" class="w-full border rounded px-2 py-1" required/>
                                </td>
                                <td>
                                    <canvas th:attr="id='signatureCanvas' + ${iterStat.index}" width="300" height="100" style="border:1px solid #000;"></canvas>
                                    <input type="hidden" th:field="*{items[__${iterStat.index}__].signature}" th:attr="id='signatureData' + ${iterStat.index}"/>
                                    <button type="button" th:attr="onclick='clearSignature(' + ${iterStat.index} + ')'" class="ml-2">지우기</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
                </div>
            </form>
        </div>
    </div>
    <th:block layout:fragment="page-js">
        <script th:inline="javascript">
            // canvas 서명 입력 기능 (여러 개 지원)
            document.addEventListener('DOMContentLoaded', function() {
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function(canvas) {
                    let drawing = false;
                    let ctx = canvas.getContext('2d');
                    let lastX = 0, lastY = 0;
                    function getXY(e) {
                        if (e.touches) {
                            const rect = canvas.getBoundingClientRect();
                            return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                        } else {
                            return [e.offsetX, e.offsetY];
                        }
                    }
                    canvas.addEventListener('mousedown', function(e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('mousemove', function(e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                    });
                    canvas.addEventListener('mouseup', function() { drawing = false; });
                    canvas.addEventListener('mouseout', function() { drawing = false; });
                    // 터치 지원
                    canvas.addEventListener('touchstart', function(e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('touchmove', function(e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                        e.preventDefault();
                    }, {passive: false});
                    canvas.addEventListener('touchend', function() { drawing = false; });
                });
            });
            // 모든 canvas의 이미지를 hidden input에 저장
            function saveAllSignatures() {
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function(canvas) {
                    const idx = canvas.id.replace('signatureCanvas', '');
                    const dataUrl = canvas.toDataURL("image/png");
                    const hidden = document.getElementById('signatureData' + idx);
                    if (hidden) hidden.value = dataUrl;
                });
            }
            // 각 행별로 서명 지우기
            function clearSignature(idx) {
                const canvas = document.getElementById('signatureCanvas' + idx);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                const hidden = document.getElementById('signatureData' + idx);
                if (hidden) hidden.value = '';
            }
            // 폼 제출 시 서명 저장
            document.querySelector('form').addEventListener('submit', function(e) {
                saveAllSignatures();
            });
        </script>
    </th:block>
</body>
</html>